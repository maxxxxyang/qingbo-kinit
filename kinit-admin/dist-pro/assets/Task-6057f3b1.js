import{a as e,r as a,b as t,d as l,c as s,p as o}from"./task-e1beb0af.js";import{u as i,_ as r}from"./Table.vue_vue_type_script_lang-5256bd69.js";import{e as n,K as p,G as u,M as d,x as m,a3 as c,N as _,r as v,P as f,o as j,j as y,m as g,k as w,ao as h,z as b,l as x,O as k}from"./index-9da7d198.js";import{E as C}from"./el-button-8f21380c.js";import{E as z}from"./el-switch-7720805d.js";import{a as P,E as R}from"./el-col-d9273186.js";import{E as S}from"./el-message-box-24354127.js";import"./el-input-26eda071.js";import"./el-overlay-037540a2.js";import{_ as D}from"./Search.vue_vue_type_script_setup_true_lang-a57e37eb.js";import{_ as E}from"./ContentWrap.vue_vue_type_script_setup_true_lang-9c7e578a.js";import{_ as A}from"./Write.vue_vue_type_script_setup_true_lang-b67fede1.js";import{_ as L}from"./Dialog.vue_vue_type_style_index_0_lang-fcbfdb5d.js";import{_ as T}from"./CronExpression.vue_vue_type_style_index_0_lang-78dfe52d.js";import"./el-table-column-102f47a6.js";import"./el-popper-2fae9050.js";import"./isNil-1f22f7b0.js";import"./index-cde97138.js";import"./use-form-common-props-9d083c67.js";import"./el-tag-aef2ce12.js";import"./index-13d6a136.js";import"./event-5568c9d8.js";import"./use-form-item-8b7f5d34.js";import"./debounce-778af7ed.js";import"./el-tooltip-4ed993c7.js";import"./useForm-ecbcdb43.js";import"./el-checkbox-group-b617b779.js";import"./el-date-picker-f32b0b71.js";import"./el-divider-fc00d058.js";import"./el-progress-69812d34.js";import"./style.css_vue_type_style_index_0_src_true_lang-0e7f3b44.js";import"./index-14d9f390.js";import"./strings-e2e316bd.js";import"./index-4dbb39b8.js";import"./el-image-viewer-83790b35.js";import"./el-dropdown-item-c082162c.js";import"./refs-4f0941bf.js";/* empty css                   */import"./_Uint8Array-bbcc3a61.js";import"./vnode-ae242abb.js";import"./useIcon-6417bbff.js";import"./el-card-5fa288fa.js";import"./useValidator-e352e7a8.js";import"./dict-b6f9162a.js";import"./dict-b26f862b.js";import"./el-tab-pane-5d623fbd.js";import"./RunDatetimeList-ccdf3646.js";import"./CronExample-cc30016c.js";import"./el-descriptions-item-be87a779.js";const U=n({name:"SystemTask",__name:"Task",setup(n){const{push:U}=p(),{t:V}=u(),{tableRegister:B,tableState:I,tableMethods:N}=i({fetchDataApi:async()=>{const{pageSize:e,currentPage:a}=I,l=await t({page:w(a),limit:w(e),...w(Q)});return{list:l.data||[],total:l.count||0}},fetchDelApi:async e=>200===(await l(e)).code}),{dataList:O,loading:K,total:M,pageSize:W,currentPage:$}=I,{getList:q,delList:F}=N,G=d([{field:"_id",label:"任务编号",show:!0,disabled:!0,width:"230px",span:24},{field:"name",label:"任务名称",show:!0,disabled:!0,span:24},{field:"group",label:"任务分组",show:!0,span:24},{field:"job_class",label:"调用目标",show:!0,span:24},{field:"exec_strategy",label:"执行策略",show:!0,colProps:{span:24},componentProps:{style:{width:"100%"}}},{field:"expression",label:"表达式",show:!0,span:24},{field:"is_active",label:"任务状态",show:!0,width:"100px",slots:{default:e=>{const a=e.row;return m(c,null,[m(z,{value:a.is_active,disabled:!0},null)])}}},{field:"last_run_datetime",label:"最近一次执行时间",show:!0,width:"180px",span:24},{field:"remark",label:"任务备注",show:!0,span:24},{field:"create_datetime",label:"创建时间",show:!0,width:"180px",span:24},{field:"action",label:"操作",show:!0,disabled:!1,width:"240px",slots:{default:e=>{const a=e.row;return m(c,null,[m(C,{type:"primary",link:!0,size:"small",onClick:()=>oe(a)},{default:()=>[_("编辑")]}),m(C,{type:"primary",link:!0,size:"small",onClick:()=>pe(a)},{default:()=>[_("调度日志")]}),m(C,{type:"primary",link:!0,size:"small",onClick:()=>ue(a)},{default:()=>[_("执行一次")]}),m(C,{type:"danger",link:!0,size:"small",onClick:()=>Y(a)},{default:()=>[_("删除")]})])}}}]),H=d([{field:"name",label:"任务名称",component:"Input",componentProps:{clearable:!0,style:{width:"214px"}}},{field:"_id",label:"任务编号",component:"Input",componentProps:{clearable:!0,style:{width:"214px"}}},{field:"group",label:"任务分组",component:"Select",componentProps:{style:{width:"214px"},options:[]}}]),Q=v({}),X=e=>{$.value=1,Q.value=e,q()},J=v(!1),Y=async e=>{J.value=!0,await F(!0,[e._id]).finally((()=>{J.value=!1}))},Z=v(!1),ee=v(""),ae=v(),te=v(""),le=v(),se=v(!1),oe=async a=>{const t=await e(a._id);t&&(ee.value="编辑定时任务",te.value="edit",ae.value=t.data,Z.value=!0)},ie=()=>{ee.value="新增定时任务",te.value="add",ae.value=void 0,Z.value=!0},re=async()=>{const e=w(le),a=await(null==e?void 0:e.submit());if(a){se.value=!0;try{const e=v({});"add"===te.value?(e.value=await s(a),e.value&&(Z.value=!1,q())):"edit"===te.value&&(e.value=await o(a._id,a),e.value&&(Z.value=!1,q()))}finally{se.value=!1}}},ne=()=>{ee.value="Cron 表达式",te.value="expression",ae.value=void 0,Z.value=!0},pe=e=>{U(e?`/system/record/task?job_id=${e._id}`:"/system/record/task")},ue=async e=>{S.confirm("是否确认立即执行一次任务","提示",{confirmButtonText:V("common.delOk"),cancelButtonText:V("common.delCancel"),type:"warning"}).then((async()=>{const t=await a(e._id);t&&(t.data>0?f.success("任务成功被消费者接收！"):f.error("执行失败，未有消费者接收任务，请检查定时任务程序状态！"))}))};return(e,a)=>(j(),y(c,null,[m(w(E),null,{default:g((()=>[m(w(D),{schema:H,onReset:X,onSearch:X},null,8,["schema"]),m(w(r),{"current-page":w($),"onUpdate:currentPage":a[1]||(a[1]=e=>h($)?$.value=e:null),"page-size":w(W),"onUpdate:pageSize":a[2]||(a[2]=e=>h(W)?W.value=e:null),showAction:"",columns:G,"default-expand-all":"","node-key":"id",data:w(O),loading:w(K),pagination:{total:w(M)},onRegister:w(B),onRefresh:w(q)},{toolbar:g((()=>[m(w(P),{gutter:10},{default:g((()=>[m(w(R),{span:1.5},{default:g((()=>[m(w(C),{type:"primary",onClick:ie},{default:g((()=>[_("新增定时任务")])),_:1})])),_:1}),m(w(R),{span:1.5},{default:g((()=>[m(w(C),{type:"primary",onClick:a[0]||(a[0]=e=>pe(null))},{default:g((()=>[_("调度日志")])),_:1})])),_:1}),m(w(R),{span:1.5},{default:g((()=>[m(w(C),{type:"primary",onClick:ne},{default:g((()=>[_("快速生成 Cron 表达式")])),_:1})])),_:1})])),_:1})])),_:1},8,["current-page","page-size","columns","data","loading","pagination","onRegister","onRefresh"])])),_:1}),m(w(L),{modelValue:Z.value,"onUpdate:modelValue":a[4]||(a[4]=e=>Z.value=e),title:ee.value,height:680,width:850},{footer:g((()=>[m(w(C),{type:"primary",loading:se.value,onClick:re},{default:g((()=>[_(b(w(V)("exampleDemo.save")),1)])),_:1},8,["loading"]),m(w(C),{onClick:a[3]||(a[3]=e=>Z.value=!1)},{default:g((()=>[_(b(w(V)("dialogDemo.close")),1)])),_:1})])),default:g((()=>["add"===te.value||"edit"===te.value?(j(),x(A,{key:0,ref_key:"writeRef",ref:le,"current-row":ae.value},null,8,["current-row"])):k("",!0),"expression"===te.value?(j(),x(T,{key:1})):k("",!0)])),_:1},8,["modelValue","title"])],64))}});export{U as default};
