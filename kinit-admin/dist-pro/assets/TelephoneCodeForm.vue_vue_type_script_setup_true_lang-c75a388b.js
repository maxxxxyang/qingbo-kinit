import{u as e,F as a}from"./useForm-ecbcdb43.js";import{e as o,K as t,L as l,v as s,M as r,x as i,a3 as n,r as d,w as u,am as p,P as c,R as m,o as v,l as f,k as h,al as g,G as w,S as y}from"./index-9da7d198.js";import{E as b}from"./el-button-8f21380c.js";import{b as R}from"./el-input-26eda071.js";import{E as k}from"./el-divider-fc00d058.js";import{u as x}from"./useValidator-e352e7a8.js";function P(e){return"function"==typeof e||"[object Object]"===Object.prototype.toString.call(e)&&!g(e)}const j=o({__name:"TelephoneCodeForm",emits:["to-password"],setup(o,{emit:g}){const{formRegister:j,formMethods:S}=e(),{getFormData:I,getElFormExpose:C}=S,{t:F}=w(),{required:E}=x(),{currentRoute:M,addRoute:_,push:q}=t(),V=l(),A=s(),{setStorage:L}=y(),O=r([{field:"title",colProps:{span:24},formItemProps:{slots:{default:()=>i("h2",{class:"text-2xl font-bold text-center w-[100%]"},[F("login.login")])}}},{field:"telephone",label:F("login.telephone"),value:"",component:"Input",colProps:{span:24},componentProps:{style:{width:"100%"},placeholder:F("login.telephonePlaceholder"),maxlength:11}},{field:"password",label:F("login.SMSCode"),colProps:{span:24},formItemProps:{slots:{default:e=>i("div",{class:"w-[100%] flex"},[i(R,{modelValue:e.password,"onUpdate:modelValue":a=>e.password=a,placeholder:F("login.codePlaceholder")},{suffix:()=>{let e;return i(n,null,[i(k,{direction:"vertical"},null),U.value?i(b,{type:"primary",link:!0,onClick:H},P(e=F("login.getSMSCode"))?e:{default:()=>[e]}):i(b,{type:"primary",disabled:!U.value,link:!0},{default:()=>[B.value+F("login.SMSCodeRetry")]})])}})])}}},{field:"method",label:"登录类型",value:"1",component:"Input",hidden:!0},{field:"login",colProps:{span:24},formItemProps:{slots:{default:()=>{let e,a;return i("div",{class:"w-[100%]"},[i("div",{class:"w-[100%]"},[i(b,{type:"primary",class:"w-[100%]",loading:G.value,onClick:T},P(e=F("login.login"))?e:{default:()=>[e]})]),i("div",{class:"w-[100%] mt-15px"},[i(b,{class:"w-[100%]",onClick:D},P(a=F("login.passwordLogin"))?a:{default:()=>[a]})])])}}}}]),z={telephone:[E()],method:[E()],password:[E()]},D=()=>{g("to-password")},G=d(!1),K=d("");u((()=>M.value),(e=>{var a;K.value=null==(a=null==e?void 0:e.query)?void 0:a.redirect}),{immediate:!0});const T=async()=>{const e=await C();if(await(null==e?void 0:e.validate())){G.value=!0;const e=await I();try{const a=await A.login(e);a?a.data.is_reset_password?J():q({path:"/reset/password"}):G.value=!1}catch(a){G.value=!1}}};let U=d(!0),B=d(60);const H=async()=>{const e=await C();if(await(null==e?void 0:e.validateField("telephone"))){U.value=!1,B.value=60;const e=await I();try{const a=await p({telephone:e.telephone});if(null==a?void 0:a.data){let e=setInterval((()=>{B.value--,B.value<1&&(U.value=!0,clearInterval(e))}),1e3)}else c.error("发送失败，请联系管理员"),U.value=!0}catch(a){U.value=!0}}},J=async()=>{const e=await m();if(e){const a=e.data||[];L("roleRouters",a),await V.generateRoutes(a).catch((()=>{})),V.getAddRouters.forEach((e=>{_(e)})),V.setIsAddRouters(!0),q({path:K.value||V.addRouters[0].path})}};return(e,o)=>(v(),f(h(a),{schema:O,rules:z,"label-position":"top","hide-required-asterisk":"",size:"large",class:"dark:border-1 dark:border-[var(--el-border-color)] dark:border-solid",onRegister:h(j)},null,8,["schema","onRegister"]))}});export{j as _};
